# Guidance For Personalized User Experience Created With Generative AI On AWS


## Table of Content

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Deployment Steps](#deployment-steps)
4. [Deployment Validation](#deployment-validation)
5. [Running the Guidance](#running-the-guidance)
6. [Next Steps](#next-steps)
7. [Cleanup](#cleanup)

## Overview

This Guidance shows how to calibrate and deploy a Stable Diffusion model to generate personalized avatars with a simple text prompt. Stable Diffusion is a text-to-image model, generated by a type of artificial intelligence (AI) that leverages the latest advances in machine learning. Here, the models are built on [Amazon SageMaker](https://docs.aws.amazon.com/sagemaker/latest/dg/whatis.html) and calibrated using the DreamBooth approach, which uses 10-15 images of the user to capture the precise details of the subject. The models are then hosted on SageMaker [Multi Model Endpoints](https://docs.aws.amazon.com/sagemaker/latest/dg/multi-model-endpoints.html) to save inference cost by share and reuse hosting infrastructure. You can then use the models to generate personalized avatar that can be used in a variety of applications, including social media, gaming, and virtual events.  The Guidance also includes a text prompt feature that allows users to generate avatars based on specific text inputs. This feature expands the capabilities of the applications and provides media and entertainment organizations more ways to develop personalize content, tailored to the consumer.

![solution architecture](statics/solution_architecture.png)

The architecture diagram above outlines the end-to-end solution. This sample focuses only on the model training and inference orchestration (green section). Users can reference the full solution architecture and build on top of the example we provide. 

The orchestration can be broken down into four steps:

1. Upload images to S3

2. Fine-tune a Stable Diffusion (SD) 2.1 base model using SageMaker Async Inference

3. Host the fine-tuned models using SageMaker MMEs with GPU.

4. Use the fine-tuned model for inference.


## Prerequisites
Make sure that your AWS identity has the requisite permissions which includes ability to create SageMaker Resources (Model, EndpointConfigs, Endpoints, and Training Jobs) in addition to S3 access to upload model artifacts. Alternatively, you can attach the [AmazonSageMakerFullAccess](https://docs.aws.amazon.com/sagemaker/latest/dg/security-iam-awsmanpol.html#security-iam-awsmanpol-AmazonSageMakerFullAccess) managed policy to your IAM User or Role.

### Operating System

This notebook is tested on **PyTorch 2.0.0 Python 3.10 GPU Optimized kernel on SageMaker Studio. An GPU instance such as ml.g4dn.xlarge is recommended.**


## Deployment Steps

1. Clone this repo using command ```git clone https://github.com/aws-solutions-library-samples/guidance-for-personalized-user-experience-created-with-generative-ai-on-aws.git```

After successfully cloning the repo, following files and libraries will be downloaded in the following directory structure:

```
|-- models
|   └── model_setup         A Triton Python backend model that prepares the common stable diffusion components on hosting container
|       |-- 1
|       |   └── model.py
|       └── config.pbtxt
|-- training_service        Training code directory to spin up a fine tuning job in a Deep Jave Library (DJL) container
|   |--model.py
|   |--serving.properties
|   |--requirements.txt
|   |--trainer.py
|   |--train_dreambooth.py
|   |--utils.py
    └── sd_lora             A Triton Python backend model template directory for LoRA fine-tuned Stable Diffusion models
        |-- 1
        |   └── model.py
        └── config.pbtxt
```     

2. cd to the repo folder ```guidance-for-personalized-user-experience-created-with-generative-ai-on-aws```

3. Upload a minimum 10 selfie images to the `data` folder. To achieve the best results, it is recommended to provide a variety of image from different angles, with different expressions, and in different backgrounds.

![Input Sample Pictures](statics/input_examples.jpg)

4. open [personalized_avatar_solution.ipynb](personalized_avatar_solution.ipynb) notebook, and follow the instructions to run through each cell. 


## Deployment Validation

After successfully deployed the solution, make sure you have 2 health SageMaker endpoint available: one for fine tuning using SageMaker Asychronous inference and another for hosting the fine tuned models using SageMaker Multi Model Endpoints

You can also validate your fine-tuned model directly in the notebook by running the following code snippet.

```
%%time
response = sm_runtime.invoke_endpoint(
    EndpointName=endpoint_name,
    ContentType="application/octet-stream",
    Body=json.dumps(payload),
    TargetModel=target_model,
)
output = json.loads(response["Body"].read().decode("utf8"))["outputs"]
original_image = decode_image(output[0]["data"][0])
original_image
```

## Running the Guidance

We also include a gradio app at the end of the notebook. Run the cell to spin up the application in notebook environment. The input parameters we exposed in the app include prompt, negative_prompt, and gen_args as shown in the gif image below. You can select the model and adjust the prompt to generate different avatar images.

Input Images          |  Personalized Output
:-------------------------:|:-------------------------:
![Inputs](statics/demo_inputs.jpg)  |  ![DEMO OUPUT](statics/avatar.gif)


## Next Steps

To further enhance your application, there are several suggested next steps. Firstly, develop and enhance the UI experience, making the application more engaging and user-friendly. Secondly, incorporating API Gateway and AWS Lambda can provide authentication and access control for your models, ensuring that only authorized users can access the application. Additionally, implementing the AWS Web Application Firewall (WAF) will protect your application from common web exploits, while adding AWS Shield will provide defense against DDoS attacks, safeguarding the availability of your application.

## Cleanup

Follow the instructions in the cleanup section of the notebook to delete the resources provisioned as part of this post to avoid unnecessary charges. Refer to [Amazon SageMaker Pricing](https://aws.amazon.com/sagemaker/pricing/) for details regarding the cost of the inference instances.


## Security

See [CONTRIBUTING](CONTRIBUTING.md#security-issue-notifications) for more information.

## License

This library is licensed under the MIT-0 License. See the LICENSE file.
